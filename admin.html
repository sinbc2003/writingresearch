<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>관리자</title>
    <style>
      *, *::before, *::after { box-sizing: border-box; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; padding: 0; background: #f7f7f9; color: #111; }
      .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
      .card { background: #fff; border: 1px solid #e6e6ef; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); padding: 16px; margin-bottom: 12px; }
      h1 { font-size: 20px; margin: 0 0 12px 0; }
      label { display:block; font-size:12px; color:#555; margin-bottom:6px; }
      input, select, button, textarea { font: inherit; }
      input[type="text"], input[type="password"], textarea { width: 100%; padding: 10px 12px; border:1px solid #ccd; border-radius: 8px; background: #fff; }
      button.primary { background: #2f6feb; color: #fff; border:none; border-radius: 8px; padding: 10px 14px; cursor: pointer; }
      button.secondary { background: #f0f1f6; color: #111; border: 1px solid #e6e6ef; border-radius: 8px; padding: 10px 14px; cursor: pointer; }
      .row { display:flex; gap: 12px; align-items:flex-end; flex-wrap: wrap; }
      .row > * { flex:1; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border:1px solid #eee; padding:8px; font-size: 13px; }
      th { background: #f6f7fb; text-align:left; }
      .help { font-size: 11px; color: #6b7280; margin-top: 4px; }
      .tabs { display:flex; gap:8px; margin: 4px 0 12px 0; flex-wrap: wrap; }
      .tab-btn { background:#f0f1f6; color:#111; border:1px solid #e6e6ef; border-radius:8px; padding:8px 12px; cursor:pointer; }
      .tab-btn.active { background:#2f6feb; color:#fff; border-color:#2f6feb; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>관리자</h1>
        <div class="row">
          <div>
            <label>비밀번호</label>
            <input id="adminPw" type="password" placeholder="관리자 비밀번호" />
          </div>
          <div style="flex:0 0 auto;">
            <button class="primary" onclick="onLogin()">확인</button>
          </div>
        </div>
      </div>

      <div id="adminPanels" style="display:none;">
        <div class="tabs">
          <button class="tab-btn active" id="tab-settings" onclick="switchTab('settings')">설정</button>
          <button class="tab-btn" id="tab-user" onclick="switchTab('user')">유저 프로퍼티</button>
          <button class="tab-btn" id="tab-match" onclick="switchTab('match')">대진 관리</button>
        </div>

        <div id="panel-settings">
          <div class="card">
          <h2 style="margin:0 0 10px 0; font-size:16px;">설정</h2>
          <div class="row" style="align-items:flex-start;">
            <div>
              <label>AI 제공자</label>
              <input id="aiProvider" type="text" placeholder="openai" />
            </div>
            <div>
              <label>AI API 키 (백업용)</label>
              <input id="aiApiKey" type="text" placeholder="보통은 비워둡니다. UserProperties가 우선" />
              <div class="help">우선순위: UserProperties.OPENAI_API_KEY → 여기 설정</div>
            </div>
            <div>
              <label>기본 모델(BASIC)</label>
              <input id="defaultModel" type="text" placeholder="예: gpt-4o-mini 또는 gpt-4.1" />
            </div>
            <div>
              <label>커스텀 모델(CUSTOM)</label>
              <input id="customModel" type="text" placeholder="예: gpt-4o 또는 gpt-4.1" />
            </div>
          </div>
          <div style="margin-top:8px;">
            <label style="font-weight:600; font-size:14px;">AI 튜터 시스템 프롬프트</label>
            <textarea id="aiTutorSystemPrompt" rows="6" placeholder="AI 튜터가 학생에게 어떻게 응답할지 안내 문구를 입력하세요."></textarea>
            <div class="help">예: 학습 목적, 말투, 피드백 방식 등을 지시할 수 있습니다.</div>
          </div>
          <div class="row" style="margin-top:8px;">
            <div>
              <label>AI 튜터 아바타 URL</label>
              <input id="aiAvatarUrl" type="text" placeholder="https://..." />
              <div class="help">Google Drive 공유 링크도 입력할 수 있으며, 자동으로 보기 가능한 URL로 변환됩니다.</div>
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <div>
              <label>교사 요약/대진 시트ID</label>
              <input id="teacherSheetId" type="text" placeholder="보통은 UserProperties.TEACHER_SHEET_ID 사용" />
              <div class="help">우선순위: UserProperties.TEACHER_SHEET_ID → 여기 설정 → 내부 Matchups 시트</div>
            </div>
            <div>
              <label>상단 링크 URL</label>
              <input id="topLinkUrl" type="text" placeholder="https://..." />
              <div class="help">메인 페이지 상단에 노출될 링크 주소</div>
            </div>
            <div>
              <label>상단 링크 텍스트(선택)</label>
              <input id="topLinkText" type="text" placeholder="예: 공지 보기" />
            </div>
          </div>
          <div style="margin-top:10px;">
            <button class="primary" onclick="onSaveSettings()">설정 저장</button>
          </div>
          </div>
        </div>

        <div id="panel-user" style="display:none;">
          <div class="card">
          <h2 style="margin:0 0 10px 0; font-size:16px;">유저 프로퍼티</h2>
          <div class="row">
            <div>
              <label>OPENAI_API_KEY (AI 키)</label>
              <input id="uApiKey" type="text" />
            </div>
            <div>
              <label>CONV_FOLDER_ID (대화 문서 저장 폴더ID)</label>
              <input id="uFolderId" type="text" />
              <div class="help">Docs 저장 폴더의 주소에서 ID만 복사해 입력</div>
            </div>
            <div>
              <label>TEACHER_SHEET_ID (요약/대진 스프레드시트ID)</label>
              <input id="uSheetId" type="text" />
              <div class="help">스프레드시트 주소의 /d/와 /edit 사이 문자열</div>
            </div>
            <div style="flex:0 0 auto;">
              <button class="primary" onclick="onSaveUserProps()">저장</button>
            </div>
          </div>
          </div>
        </div>

        <div id="panel-match" style="display:none;">
          <div class="card">
            <h2 style="margin:0 0 10px 0; font-size:16px;">대진 관리</h2>
            <div class="help" style="margin-bottom:6px;">PVP 모드에서 같은 roomId(방ID)를 가진 두 학생이 같은 방에서 채팅합니다.</div>
            <table>
              <thead>
                <tr><th>방ID(roomId)</th><th>A 학번</th><th>A 이름</th><th>B 학번</th><th>B 이름</th><th></th></tr>
              </thead>
              <tbody id="matchBody"></tbody>
            </table>
            <div class="row" style="margin-top:8px;">
              <input id="mRoomId" type="text" placeholder="방ID (비우면 자동 생성)" />
              <input id="mAId" type="text" placeholder="A 학번" />
              <input id="mAName" type="text" placeholder="A 이름" />
              <input id="mBId" type="text" placeholder="B 학번" />
              <input id="mBName" type="text" placeholder="B 이름" />
              <button class="secondary" onclick="onUpsertMatch()">추가/수정</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let authed = false;
      function $(id){ return document.getElementById(id); }
      function onLogin(){
        const pw = $('adminPw').value;
        google.script.run.withSuccessHandler(function(ok){
          authed = !!ok; if (!ok) { alert('비밀번호가 올바르지 않습니다.'); return; }
          $('adminPanels').style.display = 'block';
          loadAll();
          switchTab('settings');
        }).adminVerify(pw);
      }
      function loadAll(){ loadSettings(); loadUserProps(); loadMatchups(); }
      function loadSettings(){
        const pw = $('adminPw').value;
        google.script.run.withSuccessHandler(function(s){ if (!s) return; Object.keys(s).forEach(function(k){ const el=$(k); if (el) el.value = s[k]; }); }).adminGetSettings(pw);
      }
      function onSaveSettings(){
        const pw = $('adminPw').value;
        const payload = {
          aiProvider: $('aiProvider').value,
          aiApiKey: $('aiApiKey').value,
          defaultModel: $('defaultModel').value,
          customModel: $('customModel').value,
          aiTutorSystemPrompt: $('aiTutorSystemPrompt').value,
          aiAvatarUrl: $('aiAvatarUrl').value,
          teacherSheetId: $('teacherSheetId').value,
          topLinkUrl: $('topLinkUrl').value,
          topLinkText: $('topLinkText').value,
        };
        google.script.run.withSuccessHandler(function(s){ alert('저장되었습니다.'); loadSettings(); }).adminUpdateSettings(pw, payload);
      }
      function loadUserProps(){
        const pw = $('adminPw').value;
        google.script.run.withSuccessHandler(function(o){ if (!o) return; $('uApiKey').value = o.apiKey||''; $('uFolderId').value = o.folderId||''; $('uSheetId').value = o.sheetId||''; }).adminGetUserProps(pw);
      }
      function onSaveUserProps(){
        const pw = $('adminPw').value;
        const payload = { apiKey: $('uApiKey').value, folderId: $('uFolderId').value, sheetId: $('uSheetId').value };
        google.script.run.withSuccessHandler(function(){ alert('저장되었습니다.'); }).adminSaveUserProps(pw, payload);
      }
      function loadMatchups(){
        const pw = $('adminPw').value;
        google.script.run.withSuccessHandler(function(list){ renderMatchups(list||[]); }).adminGetMatchups(pw);
      }
      function renderMatchups(list){
        const body = $('matchBody'); body.innerHTML = '';
        list.forEach(function(m){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${m.roomId||''}</td><td>${m.studentIdA||''}</td><td>${m.nameA||''}</td><td>${m.studentIdB||''}</td><td>${m.nameB||''}</td><td><button class="secondary" onclick="delMatch('${m.roomId||''}')">삭제</button></td>`;
          body.appendChild(tr);
        });
      }
      function onUpsertMatch(){
        const pw = $('adminPw').value;
        const payload = { roomId: $('mRoomId').value || '', studentIdA: $('mAId').value, nameA: $('mAName').value, studentIdB: $('mBId').value, nameB: $('mBName').value };
        google.script.run.withSuccessHandler(function(list){ renderMatchups(list||[]); }).adminUpsertMatchup(pw, payload);
      }
      function delMatch(roomId){
        const pw = $('adminPw').value;
        if (!roomId) return;
        google.script.run.withSuccessHandler(function(list){ renderMatchups(list||[]); }).adminDeleteMatchup(pw, roomId);
      }

      function switchTab(name){
        ['settings','user','match'].forEach(function(k){
          var p = document.getElementById('panel-' + k);
          var b = document.getElementById('tab-' + k);
          if (p) p.style.display = (k === name) ? 'block' : 'none';
          if (b) b.classList.toggle('active', k === name);
        });
      }
    </script>
  </body>
</html>


