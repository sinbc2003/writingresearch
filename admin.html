<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WritingResearch 관리자</title>
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: 'Pretendard', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f7fafc;
        color: #1f2937;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 40px 16px;
      }
      .container {
        width: min(1200px, 100%);
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 18px;
        padding: 32px;
        box-shadow: 0 24px 48px rgba(15, 23, 42, 0.12);
      }
      h1, h2, h3 {
        margin: 0;
        color: #0f172a;
      }
      h1 { font-size: 26px; margin-bottom: 20px; }
      h2 { font-size: 20px; margin-bottom: 14px; }
      h3 { font-size: 16px; margin-bottom: 8px; }
      label { display: block; font-size: 13px; margin-bottom: 6px; color: #475569; font-weight: 600; }
      input, textarea, select {
        width: 100%;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #cbd5f5;
        background: #ffffff;
        color: #1f2937;
        font-size: 14px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
      }
      textarea { min-height: 140px; resize: vertical; }
      button {
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      button.primary {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: #ffffff;
      }
      button.secondary {
        background: #eef2ff;
        color: #1e3a8a;
      }
      button.danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: #ffffff;
      }
      button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
      button:not(:disabled):hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(37, 99, 235, 0.18); }
      .card {
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        background: #ffffff;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
      }
      .card + .card { margin-top: 24px; }
      .grid {
        display: grid;
        gap: 20px;
      }
      .grid-2 {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
      .status-bar {
        margin-bottom: 20px;
        padding: 12px 16px;
        border-radius: 12px;
        background: #e0f2fe;
        border: 1px solid #93c5fd;
        font-size: 13px;
        color: #1d4ed8;
      }
      .status-bar.error {
        background: #fee2e2;
        border-color: #fca5a5;
        color: #b91c1c;
      }
      .status-bar.success {
        background: #dcfce7;
        border-color: #86efac;
        color: #15803d;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th, td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        text-align: left;
      }
      tr { cursor: pointer; }
      tr:hover { background: rgba(59, 130, 246, 0.1); }
      tr.active { background: rgba(37, 99, 235, 0.22); }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }
      .badge.openai { background: rgba(37, 99, 235, 0.2); color: #bfdbfe; }
      .badge.vertex { background: rgba(16, 185, 129, 0.18); color: #bbf7d0; }
      .badge.disabled { background: #e2e8f0; color: #475569; }
      .badge.stage { background: #dbeafe; color: #1d4ed8; }
      .badge.group { background: #fee2e2; color: #b91c1c; }
      .toolbar {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-bottom: 16px;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        margin: 0;
        font-size: 13px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 14px;
        max-height: 320px;
        overflow-y: auto;
      }
      .match-form {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        align-items: end;
      }
      .match-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .detail-heading {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .detail-id {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .detail-id strong { font-size: 18px; color: #0f172a; }
      .detail-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }
      .detail-info-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        margin-top: 16px;
      }
      .detail-info-grid p { margin: 4px 0 0; }
      .detail-partner-block {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        margin-top: 20px;
      }
      .detail-partner-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .match-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .link-button {
        background: none;
        border: none;
        color: #2563eb;
        font-weight: 600;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 8px;
      }
      .link-button:hover {
        background: rgba(37, 99, 235, 0.12);
      }
      .stage-list {
        display: grid;
        gap: 16px;
        margin-top: 24px;
      }
      .stage-block {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        background: #ffffff;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
      }
      .stage-title {
        font-weight: 700;
        margin-bottom: 6px;
        color: #0f172a;
      }
      .stage-meta {
        font-size: 12px;
        color: #64748b;
        margin-bottom: 10px;
      }
      #sessionDetail pre { margin: 0; }
      .hidden { display: none !important; }
      .muted { color: #64748b; font-size: 12px; }
      @media (max-width: 960px) {
        body { padding: 24px 10px; }
        .container { padding: 24px; }
        .flex { flex-direction: column; }
      }
    </style>
    <script src="./app-config.js"></script>
  </head>
  <body>
    <div class="container">
      <div id="statusBar" class="status-bar">관리자 비밀번호를 입력하세요.</div>

      <div id="loginView">
        <h1>WritingResearch 관리자 로그인</h1>
        <div class="card" style="max-width: 420px; margin-top: 20px;">
          <label for="adminPassword">관리자 비밀번호</label>
          <input id="adminPassword" type="password" placeholder="관리자 비밀번호" />
          <div style="margin-top: 16px; display: flex; gap: 10px;">
            <button id="btnLogin" class="primary" type="button">로그인</button>
            <button id="btnClearStored" class="secondary" type="button">저장된 토큰 삭제</button>
          </div>
        </div>
      </div>

      <datalist id="sessionOptions"></datalist>

      <div id="adminView" class="hidden">
        <div class="toolbar">
          <button id="btnReloadSessions" class="secondary" type="button">세션 새로고침</button>
          <button id="btnReloadConfig" class="secondary" type="button">설정 새로고침</button>
          <button id="btnLogout" class="danger" type="button">로그아웃</button>
        </div>

        <section class="card">
          <h2>AI 설정</h2>
          <p class="muted" style="margin-bottom: 16px;">OpenAI 키 입력 시 자동으로 OpenAI가 사용되며, 비워두면 기존 키를 유지합니다.</p>
          <div class="grid grid-2">
            <div>
              <label for="aiProvider">AI 제공자</label>
              <select id="aiProvider">
                <option value="auto">자동 선택</option>
                <option value="openai">OpenAI</option>
                <option value="vertex">Vertex AI</option>
                <option value="none">비활성화</option>
              </select>
            </div>
            <div>
              <label for="aiTemperature">Temperature (0~1)</label>
              <input id="aiTemperature" type="number" step="0.05" min="0" max="1" placeholder="0.6" />
            </div>
          </div>
          <div style="margin-top: 16px;">
            <label for="aiSystemPrompt">System Prompt</label>
            <textarea id="aiSystemPrompt" placeholder="AI 기본 지침을 입력하세요."></textarea>
          </div>

          <div class="grid grid-2" style="margin-top: 20px;">
            <div>
              <h3>OpenAI</h3>
              <label for="openaiModel">모델 이름</label>
              <input id="openaiModel" type="text" placeholder="예: gpt-4o-mini" />
              <label for="openaiBaseUrl" style="margin-top: 12px;">Base URL</label>
              <input id="openaiBaseUrl" type="text" placeholder="https://api.openai.com/v1" />
              <label for="openaiOrg" style="margin-top: 12px;">조직 ID</label>
              <input id="openaiOrg" type="text" placeholder="Optional" />
              <label for="openaiApiKey" style="margin-top: 12px;">새 API 키</label>
              <input id="openaiApiKey" type="password" placeholder="새 키 입력 (비워두면 유지)" />
              <button id="btnClearOpenAiKey" class="secondary" type="button" style="margin-top: 10px;">저장된 OpenAI 키 제거</button>
            </div>
            <div>
              <h3>Vertex AI</h3>
              <label for="vertexModel">모델 이름</label>
              <input id="vertexModel" type="text" placeholder="예: gemini-1.5-flash" />
              <label for="vertexLocation" style="margin-top: 12px;">리전</label>
              <input id="vertexLocation" type="text" placeholder="예: us-central1" />
              <div class="muted" style="margin-top: 16px;">Vertex AI를 사용하려면 Cloud Run 환경 변수에 서비스 계정 권한이 필요합니다.</div>
            </div>
          </div>

          <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button id="btnSaveConfig" class="primary" type="button">설정 저장</button>
          </div>
        </section>

        <section class="card hidden" id="partnerSection">
          <h2>동료 매칭</h2>
          <p class="muted" style="margin-bottom: 12px;">세션을 선택한 후 동료의 세션 키를 지정하거나 이름/식별 번호를 직접 입력해 매칭하세요.</p>
          <div class="match-form">
            <div>
              <label for="partnerSessionInput">동료 세션 키</label>
              <input list="sessionOptions" id="partnerSessionInput" placeholder="세션 키 또는 직접 입력" />
            </div>
            <div>
              <label for="partnerNameInput">동료 이름</label>
              <input id="partnerNameInput" type="text" placeholder="자동 입력 또는 직접 입력" />
            </div>
            <div>
              <label for="partnerIdInput">동료 식별번호</label>
              <input id="partnerIdInput" type="text" placeholder="자동 입력 또는 직접 입력" />
            </div>
          </div>
          <div class="match-actions" style="margin-top: 16px;">
            <button id="btnAssignPartner" class="primary" type="button" disabled>동료 저장</button>
            <button id="btnClearPartner" class="secondary" type="button" disabled>동료 연결 해제</button>
            <button id="btnJumpPartner" class="link-button" type="button" disabled>동료 세션 열기</button>
          </div>
        </section>

        <section class="card" id="sessionListSection">
          <h2>세션 목록</h2>
          <div class="muted" style="margin-bottom: 12px;">목록에서 세션을 선택하면 상세 정보와 대화 로그를 확인하고 동료를 매칭할 수 있습니다.</div>
          <div style="overflow-x: auto;">
            <table id="sessionTable">
              <thead>
                <tr>
                  <th>세션</th>
                  <th>집단</th>
                  <th>학생</th>
                  <th>단계</th>
                  <th>동료</th>
                  <th>업데이트</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <section class="card hidden" id="sessionDetailSection">
          <h2>세션 상세</h2>
          <div id="sessionDetail" class="muted">세션을 선택하면 내용이 표시됩니다.</div>
        </section>

        <section class="card hidden" id="chatSection">
          <h2>대화 로그</h2>
          <div class="grid grid-2" style="margin-top: 16px;">
            <div>
              <h3>AI 피드백</h3>
              <pre id="aiChatLog">세션을 선택하세요.</pre>
            </div>
            <div>
              <h3>동료 피드백</h3>
              <pre id="peerChatLog">세션을 선택하세요.</pre>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script>
      (function(){
        'use strict';

        const APP = window.APP_CONFIG || { apiBaseUrl: '/api', apiKey: '' };
        let authToken = window.localStorage.getItem('writingresearch_admin_token') || '';
        let selectedSessionKey = '';
        let clearOpenAiKey = false;
        let currentSessionDetail = null;

        const sessionCache = new Map();
        const $ = (id) => document.getElementById(id);

        function normalizeBaseUrl(url){
          if (!url) return `${window.location.origin}/api/`;
          const trimmed = String(url).trim();
          if (/^https?:\/\//i.test(trimmed)) {
            return trimmed.endsWith('/') ? trimmed : `${trimmed}/`;
          }
          const prefixed = trimmed.startsWith('/') ? trimmed : `/${trimmed}`;
          const combined = `${window.location.origin}${prefixed}`;
          return combined.endsWith('/') ? combined : `${combined}/`;
        }

        const API_BASE = new URL('admin/', normalizeBaseUrl(APP.apiBaseUrl || '/api')).toString();

        function setStatus(message, type){
          const bar = $('statusBar');
          bar.textContent = message;
          bar.className = `status-bar${type ? ' ' + type : ''}`;
        }

        async function apiRequest(path, { method = 'GET', body, requireAuth = true } = {}) {
          const url = new URL(path, API_BASE).toString();
          const headers = { 'Content-Type': 'application/json' };
          if (requireAuth && authToken) headers['Authorization'] = `Bearer ${authToken}`;
          const response = await fetch(url, {
            method,
            headers,
            body: body ? JSON.stringify(body) : undefined
          });
          if (response.status === 204) return null;
          const text = await response.text();
          let payload = null;
          if (text) {
            try { payload = JSON.parse(text); } catch (err) { throw new Error('서버 응답을 해석하지 못했습니다.'); }
          }
          if (!response.ok) {
            const error = new Error(payload?.error || payload?.message || response.statusText || '요청 실패');
            error.status = response.status;
            throw error;
          }
          return payload;
        }

        function showLogin(){
          $('loginView').classList.remove('hidden');
          $('adminView').classList.add('hidden');
          setStatus('관리자 비밀번호를 입력하세요.', '');
        }

        function showAdmin(){
          $('loginView').classList.add('hidden');
          $('adminView').classList.remove('hidden');
          setStatus('관리자 모드에 접속했습니다.', 'success');
        }

        async function attemptAutoLogin(){
          if (!authToken) return false;
          try {
            await loadConfig();
            await loadSessions();
            showAdmin();
            return true;
          } catch (error) {
            authToken = '';
            window.localStorage.removeItem('writingresearch_admin_token');
            showLogin();
            return false;
          }
        }

        async function login(){
          const password = $('adminPassword').value.trim();
          if (!password) {
            setStatus('비밀번호를 입력하세요.', 'error');
            return;
          }
          $('btnLogin').disabled = true;
          try {
            const payload = await apiRequest('login', { method: 'POST', body: { password }, requireAuth: false });
            authToken = payload?.token || '';
            if (!authToken) throw new Error('토큰을 수신하지 못했습니다.');
            window.localStorage.setItem('writingresearch_admin_token', authToken);
            $('adminPassword').value = '';
            await loadConfig();
            await loadSessions();
            showAdmin();
          } catch (error) {
            setStatus(error.message || '로그인에 실패했습니다.', 'error');
          } finally {
            $('btnLogin').disabled = false;
          }
        }

        async function logout(){
          try {
            await apiRequest('logout', { method: 'POST' });
          } catch (error) {
            console.warn(error);
          }
          authToken = '';
          window.localStorage.removeItem('writingresearch_admin_token');
          $('adminPassword').value = '';
          sessionCache.clear();
          currentSessionDetail = null;
          $('sessionTable').querySelector('tbody').innerHTML = '';
          resetDetailPanels();
          clearOpenAiKey = false;
          showLogin();
        }

        async function loadConfig(){
          const data = await apiRequest('config');
          const ai = data?.ai || {};
          const overrides = data?.overrides || {};
          $('aiProvider').value = overrides.provider || 'auto';
          $('aiTemperature').value = overrides.temperature ?? '';
          $('aiSystemPrompt').value = overrides.systemPrompt || '';
          $('openaiModel').value = overrides.openai?.model || ai.openai?.model || '';
          $('openaiBaseUrl').value = overrides.openai?.baseUrl || ai.openai?.baseUrl || '';
          $('openaiOrg').value = overrides.openai?.organization || ai.openai?.organization || '';
          $('vertexModel').value = overrides.vertex?.model || ai.vertex?.model || '';
          $('vertexLocation').value = overrides.vertex?.location || ai.vertex?.location || '';
          $('openaiApiKey').value = '';
          clearOpenAiKey = false;

          const badge = document.createElement('span');
          badge.className = `badge ${ai.provider === 'openai' ? 'openai' : ai.provider === 'vertex' ? 'vertex' : 'disabled'}`;
          badge.textContent = ai.provider === 'openai' ? 'OpenAI 사용 중' : ai.provider === 'vertex' ? 'Vertex AI 사용 중' : 'AI 비활성화';
          const statusContainer = document.createElement('div');
          statusContainer.className = 'ai-status';
          statusContainer.appendChild(badge);
          const configSection = $('adminView').querySelector('section.card');
          const previousStatus = configSection.querySelector('.ai-status');
          if (previousStatus) previousStatus.remove();
          configSection.insertBefore(statusContainer, configSection.children[1]);
        }

        async function saveConfig(){
          const provider = $('aiProvider').value;
          const temperatureValue = $('aiTemperature').value;
          const systemPrompt = $('aiSystemPrompt').value;
          const payload = {
            provider,
            temperature: temperatureValue === '' ? null : Number(temperatureValue),
            systemPrompt,
            openai: {
              model: $('openaiModel').value,
              baseUrl: $('openaiBaseUrl').value,
              organization: $('openaiOrg').value
            },
            vertex: {
              model: $('vertexModel').value,
              location: $('vertexLocation').value
            }
          };

          const apiKeyInput = $('openaiApiKey').value;
          if (clearOpenAiKey) {
            payload.openai.apiKey = null;
          } else if (apiKeyInput && apiKeyInput.trim()) {
            payload.openai.apiKey = apiKeyInput.trim();
          }

          $('btnSaveConfig').disabled = true;
          try {
            await apiRequest('config', { method: 'POST', body: payload });
            $('openaiApiKey').value = '';
            clearOpenAiKey = false;
            setStatus('AI 설정이 저장되었습니다.', 'success');
            await loadConfig();
          } catch (error) {
            setStatus(error.message || '설정 저장에 실패했습니다.', 'error');
          } finally {
            $('btnSaveConfig').disabled = false;
          }
        }

        async function loadSessions(){
          const data = await apiRequest('sessions');
          const list = data?.sessions || [];
          const tbody = $('sessionTable').querySelector('tbody');
          const optionList = $('sessionOptions');
          tbody.innerHTML = '';
          optionList.innerHTML = '';
          sessionCache.clear();

          if (!list.length) {
            resetDetailPanels();
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 6;
            cell.className = 'muted';
            cell.textContent = '등록된 세션이 없습니다.';
            row.appendChild(cell);
            tbody.appendChild(row);
            return;
          }

          list.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
          list.forEach((item) => {
            sessionCache.set(item.sessionKey, item);
            const option = document.createElement('option');
            option.value = item.sessionKey;
            const studentLabel = `${item.user?.name || ''} ${item.user?.id ? `(${item.user.id})` : ''}`.trim();
            option.label = `${item.sessionKey} · ${studentLabel || '학생 정보 없음'}`;
            optionList.appendChild(option);

            const row = document.createElement('tr');
            row.dataset.sessionKey = item.sessionKey;
            if (item.sessionKey === selectedSessionKey) row.classList.add('active');
            const stageLabel = `단계 ${item.stage || 1}`;
            const updated = item.updatedAt ? formatDateTime(item.updatedAt) : '-';
            const partnerLabel = formatPartnerCell(item.partner);
            row.innerHTML = `
              <td>${item.sessionKey}</td>
              <td>${item.group || '-'}</td>
              <td>${escapeHtml(item.user?.name || '')} ${item.user?.id ? `(${escapeHtml(item.user.id)})` : ''}</td>
              <td>${stageLabel}</td>
              <td>${partnerLabel}</td>
              <td>${updated}</td>
            `;
            row.addEventListener('click', () => selectSession(item.sessionKey));
            tbody.appendChild(row);
          });
        }

        async function selectSession(sessionKey){
          selectedSessionKey = sessionKey;
          const rows = $('sessionTable').querySelectorAll('tbody tr');
          rows.forEach((row) => {
            row.classList.toggle('active', row.dataset.sessionKey === sessionKey);
          });
          setStatus(`세션 ${sessionKey} 상세 정보를 불러오는 중입니다.`, '');
          try {
            const [{ session }, aiChats, peerChats] = await Promise.all([
              apiRequest(`sessions/${sessionKey}`),
              apiRequest(`sessions/${sessionKey}/chats/ai`),
              apiRequest(`sessions/${sessionKey}/chats/peer`)
            ]);
            currentSessionDetail = session;
            sessionCache.set(session.sessionKey, {
              ...(sessionCache.get(session.sessionKey) || {}),
              partner: session.partner,
              user: session.you,
              group: session.mode,
              stage: session.stage,
              updatedAt: session.updatedAt
            });
            showDetailPanels();
            renderSessionDetail(session);
            populatePartnerForm(session);
            renderChatLogs(aiChats?.messages || [], peerChats?.messages || []);
            setStatus(`세션 ${sessionKey} 상세 정보를 불러왔습니다.`, 'success');
          } catch (error) {
            setStatus(error.message || '세션 정보를 불러오지 못했습니다.', 'error');
          }
        }

        function renderSessionDetail(session){
          const container = $('sessionDetail');
          if (!session) {
            container.textContent = '세션 데이터를 찾을 수 없습니다.';
            return;
          }
          const updatedAt = session.updatedAt ? formatDateTime(session.updatedAt) : '정보 없음';
          const createdAt = session.createdAt ? formatDateTime(session.createdAt) : '정보 없음';
          const studentName = escapeHtml(session.you?.name || '이름 없음');
          const studentId = escapeHtml(session.you?.id || '-');
          const partnerInfo = session.partner ? formatPartnerDetail(session.partner) : '';

          const stageBlocks = buildStageBlocks(session).join('');

          container.innerHTML = `
            <div class="detail-heading">
              <div class="detail-id">
                <strong>${studentName}</strong>
                <span class="badge group">${escapeHtml(session.mode || '-')} 집단</span>
                <span class="badge stage">단계 ${session.stage || 1}</span>
              </div>
              <div class="muted">최근 업데이트 · ${updatedAt}</div>
            </div>
            <div class="detail-info-grid">
              <div><span class="detail-label">세션 키</span><p>${escapeHtml(session.sessionKey)}</p></div>
              <div><span class="detail-label">식별 번호</span><p>${studentId}</p></div>
              <div><span class="detail-label">생성 시간</span><p>${createdAt}</p></div>
              <div><span class="detail-label">AI 세션</span><p>${escapeHtml(session.aiSessionId || '-')}</p></div>
            </div>
            ${partnerInfo}
            <div class="stage-list">
              ${stageBlocks}
            </div>
          `;
        }

        function renderChatLogs(aiMessages, peerMessages){
          const format = (list) => {
            if (!list.length) return '대화 기록이 없습니다.';
            return list
              .map((msg) => {
                const time = msg.ts ? formatDateTime(msg.ts) : '';
                const name = msg.senderName || msg.role || '사용자';
                return `[${time}] ${name}:\n${msg.text || ''}`;
              })
              .join('\n\n');
          };
          $('aiChatLog').textContent = format(aiMessages);
          $('peerChatLog').textContent = format(peerMessages);
        }

        $('btnLogin').addEventListener('click', login);
        $('btnClearStored').addEventListener('click', () => {
          window.localStorage.removeItem('writingresearch_admin_token');
          authToken = '';
          setStatus('저장된 토큰을 삭제했습니다.', 'success');
        });
        $('btnLogout').addEventListener('click', logout);
        $('btnReloadSessions').addEventListener('click', async () => {
          try {
            await loadSessions();
            setStatus('세션 목록을 새로고침했습니다.', 'success');
          } catch (error) {
            setStatus(error.message || '세션 목록을 불러오지 못했습니다.', 'error');
          }
        });
        $('btnReloadConfig').addEventListener('click', async () => {
          try {
            await loadConfig();
            setStatus('AI 설정을 새로고침했습니다.', 'success');
          } catch (error) {
            setStatus(error.message || 'AI 설정을 불러오지 못했습니다.', 'error');
          }
        });
        $('btnSaveConfig').addEventListener('click', saveConfig);
        $('btnClearOpenAiKey').addEventListener('click', () => {
          clearOpenAiKey = true;
          $('openaiApiKey').value = '';
          setStatus('OpenAI 키를 삭제하도록 설정했습니다. 저장을 눌러 반영하세요.', '');
        });

        $('partnerSessionInput').addEventListener('change', handlePartnerSessionSelect);
        ['partnerSessionInput', 'partnerNameInput', 'partnerIdInput'].forEach((id) => {
          $(id).addEventListener('input', handlePartnerFormChange);
        });
        $('btnAssignPartner').addEventListener('click', assignPartner);
        $('btnClearPartner').addEventListener('click', clearPartner);
        $('btnJumpPartner').addEventListener('click', jumpToPartner);

        attemptAutoLogin();
        function resetDetailPanels(){
          $('sessionDetailSection').classList.add('hidden');
          $('chatSection').classList.add('hidden');
          $('partnerSection').classList.add('hidden');
          $('sessionDetail').textContent = '세션을 선택하면 내용이 표시됩니다.';
          $('aiChatLog').textContent = '세션을 선택하세요.';
          $('peerChatLog').textContent = '세션을 선택하세요.';
          $('partnerSessionInput').value = '';
          $('partnerNameInput').value = '';
          $('partnerIdInput').value = '';
          $('btnAssignPartner').disabled = true;
          $('btnClearPartner').disabled = true;
          $('btnJumpPartner').disabled = true;
          $('btnJumpPartner').dataset.sessionKey = '';
        }

        function showDetailPanels(){
          $('sessionDetailSection').classList.remove('hidden');
          $('chatSection').classList.remove('hidden');
          $('partnerSection').classList.remove('hidden');
        }

        function formatPartnerCell(partner){
          if (!partner) return '<span class="muted">-</span>';
          const name = escapeHtml(partner.name || '이름 없음');
          const id = escapeHtml(partner.id || '');
          const sessionKey = escapeHtml(partner.sessionKey || '');
          const parts = [name];
          if (id) parts.push(`(${id})`);
          if (sessionKey) parts.push(`<br/><span class="muted">${sessionKey}</span>`);
          return parts.join(' ');
        }

        function formatPartnerDetail(partner){
          const name = escapeHtml(partner.name || '미지정');
          const id = escapeHtml(partner.id || '-');
          const sessionKey = escapeHtml(partner.sessionKey || '-');
          return `
            <div class="detail-partner-block">
              <div class="detail-partner-header">
                <div>
                  <span class="detail-label">동료 매칭</span>
                  <p style="margin: 4px 0 0; font-weight: 600;">${name}</p>
                </div>
                <span class="muted">세션 키 · ${sessionKey}</span>
              </div>
              <div class="muted">식별 번호 · ${id}</div>
            </div>
          `;
        }

        function buildStageBlocks(session){
          const list = [];
          const stages = [
            {
              title: '1단계 · 사전 글쓰기',
              meta: session.writing?.prewriting?.submittedAt ? `제출 시간 · ${formatDateTime(session.writing.prewriting.submittedAt)}` : '제출되지 않았습니다.',
              text: session.writing?.prewriting?.text,
              empty: '사전 글쓰기가 작성되지 않았습니다.'
            },
            {
              title: '2단계 · 수정 아이디어 메모',
              meta: session.writing?.draft?.savedAt ? `저장 시간 · ${formatDateTime(session.writing.draft.savedAt)}` : '저장된 메모가 없습니다.',
              text: session.writing?.draft?.text,
              empty: '2단계 메모가 작성되지 않았습니다.'
            },
            {
              title: '3단계 · 동료 피드백 메모',
              meta: session.writing?.notes?.updatedAt ? `저장 시간 · ${formatDateTime(session.writing.notes.updatedAt)}` : '작성된 동료 피드백 메모가 없습니다.',
              text: session.writing?.notes?.text,
              empty: '3단계 메모가 작성되지 않았습니다.'
            },
            {
              title: '4단계 · 최종 글',
              meta: session.writing?.final?.submittedAt ? `제출 시간 · ${formatDateTime(session.writing.final.submittedAt)}` : '최종 글이 아직 제출되지 않았습니다.',
              text: session.writing?.final?.text,
              empty: '최종 글이 아직 작성되지 않았습니다.'
            }
          ];

          stages.forEach((stage) => {
            const content = stage.text ? escapeHtml(stage.text) : `<span class="muted">${stage.empty}</span>`;
            list.push(`
              <div class="stage-block">
                <div class="stage-title">${stage.title}</div>
                <div class="stage-meta">${stage.meta}</div>
                <pre>${content}</pre>
              </div>
            `);
          });
          return list;
        }

        function populatePartnerForm(session){
          const assignBtn = $('btnAssignPartner');
          const clearBtn = $('btnClearPartner');
          const jumpBtn = $('btnJumpPartner');
          const sessionInput = $('partnerSessionInput');
          const nameInput = $('partnerNameInput');
          const idInput = $('partnerIdInput');

          if (!session) {
            assignBtn.disabled = true;
            clearBtn.disabled = true;
            jumpBtn.disabled = true;
            jumpBtn.dataset.sessionKey = '';
            sessionInput.value = '';
            nameInput.value = '';
            idInput.value = '';
            return;
          }

          const partner = session.partner || null;
          sessionInput.value = partner?.sessionKey || '';
          nameInput.value = partner?.name || '';
          idInput.value = partner?.id || '';
          assignBtn.disabled = true;
          clearBtn.disabled = !partner;
          jumpBtn.disabled = !partner?.sessionKey;
          jumpBtn.dataset.sessionKey = partner?.sessionKey || '';
        }

        function handlePartnerSessionSelect(){
          const key = $('partnerSessionInput').value.trim();
          if (!key) return;
          const info = sessionCache.get(key);
          if (!info) return;
          if (!$('partnerNameInput').value) $('partnerNameInput').value = info.user?.name || '';
          if (!$('partnerIdInput').value) $('partnerIdInput').value = info.user?.id || '';
          handlePartnerFormChange();
        }

        function handlePartnerFormChange(){
          if (!currentSessionDetail) return;
          const sessionValue = $('partnerSessionInput').value.trim();
          const nameValue = $('partnerNameInput').value.trim();
          const idValue = $('partnerIdInput').value.trim();
          const existing = currentSessionDetail.partner || {};
          const changed =
            sessionValue !== (existing.sessionKey || '') ||
            nameValue !== (existing.name || '') ||
            idValue !== (existing.id || '');
          $('btnAssignPartner').disabled = !(changed && (sessionValue || nameValue || idValue));
        }

        async function assignPartner(){
          if (!selectedSessionKey) return;
          const payload = {};
          const sessionValue = $('partnerSessionInput').value.trim();
          const nameValue = $('partnerNameInput').value.trim();
          const idValue = $('partnerIdInput').value.trim();
          if (sessionValue) payload.partnerSessionKey = sessionValue;
          if (nameValue) payload.partnerName = nameValue;
          if (idValue) payload.partnerId = idValue;

          $('btnAssignPartner').disabled = true;
          try {
            const response = await apiRequest(`sessions/${selectedSessionKey}/partner`, { method: 'POST', body: payload });
            currentSessionDetail = response.session;
            setStatus('동료 정보를 저장했습니다.', 'success');
            populatePartnerForm(currentSessionDetail);
            renderSessionDetail(currentSessionDetail);
            await loadSessions();
          } catch (error) {
            setStatus(error.message || '동료 정보를 저장하지 못했습니다.', 'error');
          }
        }

        async function clearPartner(){
          if (!selectedSessionKey) return;
          $('btnClearPartner').disabled = true;
          try {
            const response = await apiRequest(`sessions/${selectedSessionKey}/partner`, { method: 'DELETE' });
            currentSessionDetail = response.session;
            setStatus('동료 연결을 해제했습니다.', 'success');
            populatePartnerForm(currentSessionDetail);
            renderSessionDetail(currentSessionDetail);
            await loadSessions();
          } catch (error) {
            setStatus(error.message || '동료 연결을 해제하지 못했습니다.', 'error');
          }
        }

        function jumpToPartner(){
          const key = $('btnJumpPartner').dataset.sessionKey;
          if (!key) return;
          selectSession(key);
        }

        function formatDateTime(ms){
          if (!ms) return '정보 없음';
          return new Date(ms).toLocaleString('ko-KR');
        }

        function escapeHtml(str){
          return String(str || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }

        attemptAutoLogin();
      })();
    </script>
  </body>
</html>
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>관리자</title>
    <style>
      *, *::before, *::after { box-sizing: border-box; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; padding: 0; background: #f7f7f9; color: #111; }
      .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
      .card { background: #fff; border: 1px solid #e6e6ef; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); padding: 16px; margin-bottom: 12px; }
      h1 { font-size: 20px; margin: 0 0 12px 0; }
      label { display:block; font-size:12px; color:#555; margin-bottom:6px; }
      input, select, button, textarea { font: inherit; }
      input[type="text"], input[type="password"], textarea { width: 100%; padding: 10px 12px; border:1px solid #ccd; border-radius: 8px; background: #fff; }
      button.primary { background: #2f6feb; color: #fff; border:none; border-radius: 8px; padding: 10px 14px; cursor: pointer; }
      button.secondary { background: #f0f1f6; color: #111; border: 1px solid #e6e6ef; border-radius: 8px; padding: 10px 14px; cursor: pointer; }
      .row { display:flex; gap: 12px; align-items:flex-end; flex-wrap: wrap; }
      .row > * { flex:1; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border:1px solid #eee; padding:8px; font-size: 13px; }
      th { background: #f6f7fb; text-align:left; }
      .help { font-size: 11px; color: #6b7280; margin-top: 4px; }
      .tabs { display:flex; gap:8px; margin: 4px 0 12px 0; flex-wrap: wrap; }
      .tab-btn { background:#f0f1f6; color:#111; border:1px solid #e6e6ef; border-radius:8px; padding:8px 12px; cursor:pointer; }
      .tab-btn.active { background:#2f6feb; color:#fff; border-color:#2f6feb; }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>관리자</h1>
        <div class="row">
          <div>
            <label>비밀번호</label>
            <input id="adminPw" type="password" placeholder="관리자 비밀번호" />
          </div>
          <div style="flex:0 0 auto;">
            <button class="primary" onclick="onLogin()">확인</button>
          </div>
        </div>
      </div>

      <div id="adminPanels" style="display:none;">
        <div class="tabs">
          <button class="tab-btn active" id="tab-settings" onclick="switchTab('settings')">설정</button>
          <button class="tab-btn" id="tab-user" onclick="switchTab('user')">유저 프로퍼티</button>
          <button class="tab-btn" id="tab-match" onclick="switchTab('match')">대진 관리</button>
        </div>

        <div id="panel-settings">
          <div class="card">
          <h2 style="margin:0 0 10px 0; font-size:16px;">설정</h2>
          <div class="row" style="align-items:flex-start;">
            <div>
              <label>AI 제공자</label>
              <input id="aiProvider" type="text" placeholder="openai" />
            </div>
            <div>
              <label>AI API 키 (백업용)</label>
              <input id="aiApiKey" type="text" placeholder="보통은 비워둡니다. UserProperties가 우선" />
              <div class="help">우선순위: UserProperties.OPENAI_API_KEY → 여기 설정</div>
            </div>
            <div>
              <label>기본 모델(BASIC)</label>
              <input id="defaultModel" type="text" placeholder="예: gpt-4o-mini 또는 gpt-4.1" />
            </div>
            <div>
              <label>커스텀 모델(CUSTOM)</label>
              <input id="customModel" type="text" placeholder="예: gpt-4o 또는 gpt-4.1" />
            </div>
          </div>
          <div style="margin-top:8px;">
            <label style="font-weight:600; font-size:14px;">AI 튜터 시스템 프롬프트</label>
            <textarea id="aiTutorSystemPrompt" rows="6" placeholder="AI 튜터가 학생에게 어떻게 응답할지 안내 문구를 입력하세요."></textarea>
            <div class="help">예: 학습 목적, 말투, 피드백 방식 등을 지시할 수 있습니다.</div>
          </div>
          <div class="row" style="margin-top:8px;">
            <div>
              <label>AI 튜터 아바타 URL</label>
              <input id="aiAvatarUrl" type="text" placeholder="https://..." />
              <div class="help">Google Drive 공유 링크도 입력할 수 있으며, 자동으로 보기 가능한 URL로 변환됩니다.</div>
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <div>
              <label>교사 요약/대진 시트ID</label>
              <input id="teacherSheetId" type="text" placeholder="보통은 UserProperties.TEACHER_SHEET_ID 사용" />
              <div class="help">우선순위: UserProperties.TEACHER_SHEET_ID → 여기 설정 → 내부 Matchups 시트</div>
            </div>
            <div>
              <label>상단 링크 URL</label>
              <input id="topLinkUrl" type="text" placeholder="https://..." />
              <div class="help">메인 페이지 상단에 노출될 링크 주소</div>
            </div>
            <div>
              <label>상단 링크 텍스트(선택)</label>
              <input id="topLinkText" type="text" placeholder="예: 공지 보기" />
            </div>
          </div>
          <div style="margin-top:10px;">
            <button class="primary" onclick="onSaveSettings()">설정 저장</button>
          </div>
          </div>
        </div>

        <div id="panel-user" style="display:none;">
          <div class="card">
          <h2 style="margin:0 0 10px 0; font-size:16px;">유저 프로퍼티</h2>
          <div class="row">
            <div>
              <label>OPENAI_API_KEY (AI 키)</label>
              <input id="uApiKey" type="text" />
            </div>
            <div>
              <label>CONV_FOLDER_ID (대화 문서 저장 폴더ID)</label>
              <input id="uFolderId" type="text" />
              <div class="help">Docs 저장 폴더의 주소에서 ID만 복사해 입력</div>
            </div>
            <div>
              <label>TEACHER_SHEET_ID (요약/대진 스프레드시트ID)</label>
              <input id="uSheetId" type="text" />
              <div class="help">스프레드시트 주소의 /d/와 /edit 사이 문자열</div>
            </div>
            <div style="flex:0 0 auto;">
              <button class="primary" onclick="onSaveUserProps()">저장</button>
            </div>
          </div>
          </div>
        </div>

        <div id="panel-match" style="display:none;">
          <div class="card">
            <h2 style="margin:0 0 10px 0; font-size:16px;">대진 관리</h2>
            <div class="help" style="margin-bottom:6px;">PVP 모드에서 같은 roomId(방ID)를 가진 두 학생이 같은 방에서 채팅합니다.</div>
            <table>
              <thead>
                <tr><th>방ID(roomId)</th><th>A 학번</th><th>A 이름</th><th>B 학번</th><th>B 이름</th><th></th></tr>
              </thead>
              <tbody id="matchBody"></tbody>
            </table>
            <div class="row" style="margin-top:8px;">
              <input id="mRoomId" type="text" placeholder="방ID (비우면 자동 생성)" />
              <input id="mAId" type="text" placeholder="A 학번" />
              <input id="mAName" type="text" placeholder="A 이름" />
              <input id="mBId" type="text" placeholder="B 학번" />
              <input id="mBName" type="text" placeholder="B 이름" />
              <button class="secondary" onclick="onUpsertMatch()">추가/수정</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let authed = false;
      function $(id){ return document.getElementById(id); }
      function onLogin(){
        const pw = $('adminPw').value;
        google.script.run.withSuccessHandler(function(ok){
          authed = !!ok; if (!ok) { alert('비밀번호가 올바르지 않습니다.'); return; }
          $('adminPanels').style.display = 'block';
          loadAll();
          switchTab('settings');
        }).adminVerify(pw);
      }
      function loadAll(){ loadSettings(); loadUserProps(); loadMatchups(); }
      function loadSettings(){
        const pw = $('adminPw').value;
        google.script.run.withSuccessHandler(function(s){ if (!s) return; Object.keys(s).forEach(function(k){ const el=$(k); if (el) el.value = s[k]; }); }).adminGetSettings(pw);
      }
      function onSaveSettings(){
        const pw = $('adminPw').value;
        const payload = {
          aiProvider: $('aiProvider').value,
          aiApiKey: $('aiApiKey').value,
          defaultModel: $('defaultModel').value,
          customModel: $('customModel').value,
          aiTutorSystemPrompt: $('aiTutorSystemPrompt').value,
          aiAvatarUrl: $('aiAvatarUrl').value,
          teacherSheetId: $('teacherSheetId').value,
          topLinkUrl: $('topLinkUrl').value,
          topLinkText: $('topLinkText').value,
        };
        google.script.run.withSuccessHandler(function(s){ alert('저장되었습니다.'); loadSettings(); }).adminUpdateSettings(pw, payload);
      }
      function loadUserProps(){
        const pw = $('adminPw').value;
        google.script.run.withSuccessHandler(function(o){ if (!o) return; $('uApiKey').value = o.apiKey||''; $('uFolderId').value = o.folderId||''; $('uSheetId').value = o.sheetId||''; }).adminGetUserProps(pw);
      }
      function onSaveUserProps(){
        const pw = $('adminPw').value;
        const payload = { apiKey: $('uApiKey').value, folderId: $('uFolderId').value, sheetId: $('uSheetId').value };
        google.script.run.withSuccessHandler(function(){ alert('저장되었습니다.'); }).adminSaveUserProps(pw, payload);
      }
      function loadMatchups(){
        const pw = $('adminPw').value;
        google.script.run.withSuccessHandler(function(list){ renderMatchups(list||[]); }).adminGetMatchups(pw);
      }
      function renderMatchups(list){
        const body = $('matchBody'); body.innerHTML = '';
        list.forEach(function(m){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${m.roomId||''}</td><td>${m.studentIdA||''}</td><td>${m.nameA||''}</td><td>${m.studentIdB||''}</td><td>${m.nameB||''}</td><td><button class="secondary" onclick="delMatch('${m.roomId||''}')">삭제</button></td>`;
          body.appendChild(tr);
        });
      }
      function onUpsertMatch(){
        const pw = $('adminPw').value;
        const payload = { roomId: $('mRoomId').value || '', studentIdA: $('mAId').value, nameA: $('mAName').value, studentIdB: $('mBId').value, nameB: $('mBName').value };
        google.script.run.withSuccessHandler(function(list){ renderMatchups(list||[]); }).adminUpsertMatchup(pw, payload);
      }
      function delMatch(roomId){
        const pw = $('adminPw').value;
        if (!roomId) return;
        google.script.run.withSuccessHandler(function(list){ renderMatchups(list||[]); }).adminDeleteMatchup(pw, roomId);
      }

      function switchTab(name){
        ['settings','user','match'].forEach(function(k){
          var p = document.getElementById('panel-' + k);
          var b = document.getElementById('tab-' + k);
          if (p) p.style.display = (k === name) ? 'block' : 'none';
          if (b) b.classList.toggle('active', k === name);
        });
      }
    </script>
  </body>
</html>


