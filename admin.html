<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WritingResearch 관리자</title>
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: 'Pretendard', 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f7fafc;
        color: #1f2937;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 40px 16px;
      }
      .container {
        width: min(1200px, 100%);
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 18px;
        padding: 32px;
        box-shadow: 0 24px 48px rgba(15, 23, 42, 0.12);
      }
      h1, h2, h3 {
        margin: 0;
        color: #0f172a;
      }
      h1 { font-size: 26px; margin-bottom: 20px; }
      h2 { font-size: 20px; margin-bottom: 14px; }
      h3 { font-size: 16px; margin-bottom: 8px; }
      label { display: block; font-size: 13px; margin-bottom: 6px; color: #475569; font-weight: 600; }
      input, textarea, select {
        width: 100%;
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #cbd5f5;
        background: #ffffff;
        color: #1f2937;
        font-size: 14px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
      }
      textarea { min-height: 140px; resize: vertical; }
      button {
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      button.primary {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: #ffffff;
      }
      button.secondary {
        background: #eef2ff;
        color: #1e3a8a;
      }
      button.danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: #ffffff;
      }
      button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
      button:not(:disabled):hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(37, 99, 235, 0.18); }
      .card {
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        background: #ffffff;
        padding: 20px;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
      }
      .card + .card { margin-top: 24px; }
      .grid {
        display: grid;
        gap: 20px;
      }
      .grid-2 {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
      .status-bar {
        margin-bottom: 20px;
        padding: 12px 16px;
        border-radius: 12px;
        background: #e0f2fe;
        border: 1px solid #93c5fd;
        font-size: 13px;
        color: #1d4ed8;
      }
      .status-bar.error {
        background: #fee2e2;
        border-color: #fca5a5;
        color: #b91c1c;
      }
      .status-bar.success {
        background: #dcfce7;
        border-color: #86efac;
        color: #15803d;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th, td {
        padding: 10px 12px;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        text-align: left;
      }
      tr { cursor: pointer; }
      tr:hover { background: rgba(59, 130, 246, 0.1); }
      tr.active { background: rgba(37, 99, 235, 0.22); }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }
      .badge.openai { background: rgba(37, 99, 235, 0.2); color: #bfdbfe; }
      .badge.vertex { background: rgba(16, 185, 129, 0.18); color: #bbf7d0; }
      .badge.disabled { background: #e2e8f0; color: #475569; }
      .badge.stage { background: #dbeafe; color: #1d4ed8; }
      .badge.group { background: #fee2e2; color: #b91c1c; }
      .toolbar {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-bottom: 16px;
      }
      pre {
        white-space: pre-wrap;
        word-break: break-word;
        margin: 0;
        font-size: 13px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 14px;
        max-height: 320px;
        overflow-y: auto;
      }
      .match-form {
        display: grid;
        gap: 16px;
      }
      .match-form textarea {
        width: 100%;
        min-height: 100px;
        resize: vertical;
        font-family: inherit;
      }
      .match-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .detail-heading {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .detail-id {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .detail-id strong { font-size: 18px; color: #0f172a; }
      .detail-label {
        font-size: 12px;
        color: #64748b;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }
      .detail-info-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        margin-top: 16px;
      }
      .detail-info-grid p { margin: 4px 0 0; }
      .detail-partner-block {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        margin-top: 20px;
      }
      .detail-partner-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .match-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      .link-button {
        background: none;
        border: none;
        color: #2563eb;
        font-weight: 600;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 8px;
      }
      .link-button:hover {
        background: rgba(37, 99, 235, 0.12);
      }
      .stage-list {
        display: grid;
        gap: 16px;
        margin-top: 24px;
      }
      .stage-block {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        background: #ffffff;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
      }
      .stage-title {
        font-weight: 700;
        margin-bottom: 6px;
        color: #0f172a;
      }
      .stage-meta {
        font-size: 12px;
        color: #64748b;
        margin-bottom: 10px;
      }
      #sessionDetail pre { margin: 0; }
      .hidden { display: none !important; }
      .muted { color: #64748b; font-size: 12px; }
      @media (max-width: 960px) {
        body { padding: 24px 10px; }
        .container { padding: 24px; }
        .flex { flex-direction: column; }
      }
    </style>
    <script src="./app-config.js"></script>
  </head>
  <body>
    <div class="container">
      <div id="statusBar" class="status-bar">관리자 비밀번호를 입력하세요.</div>

      <div id="loginView">
        <h1>WritingResearch 관리자 로그인</h1>
        <div class="card" style="max-width: 420px; margin-top: 20px;">
          <label for="adminPassword">관리자 비밀번호</label>
          <input id="adminPassword" type="password" placeholder="관리자 비밀번호" />
          <div style="margin-top: 16px; display: flex; gap: 10px;">
            <button id="btnLogin" class="primary" type="button">로그인</button>
            <button id="btnClearStored" class="secondary" type="button">저장된 토큰 삭제</button>
          </div>
        </div>
      </div>

      <datalist id="sessionOptions"></datalist>

      <div id="adminView" class="hidden">
        <div class="toolbar">
          <button id="btnReloadSessions" class="secondary" type="button">세션 새로고침</button>
          <button id="btnReloadConfig" class="secondary" type="button">설정 새로고침</button>
          <button id="btnDownloadExport" class="secondary" type="button">데이터 다운로드</button>
          <button id="btnLogout" class="danger" type="button">로그아웃</button>
        </div>

        <section class="card">
          <h2>AI 설정</h2>
          <p class="muted" style="margin-bottom: 16px;">OpenAI 키 입력 시 자동으로 OpenAI가 사용되며, 비워두면 기존 키를 유지합니다.</p>
          <div class="grid grid-2">
            <div>
              <label for="aiProvider">AI 제공자</label>
              <select id="aiProvider">
                <option value="auto">자동 선택</option>
                <option value="openai">OpenAI</option>
                <option value="vertex">Vertex AI</option>
                <option value="none">비활성화</option>
              </select>
            </div>
            <div>
              <label for="aiTemperature">Temperature (0~1)</label>
              <input id="aiTemperature" type="number" step="0.05" min="0" max="1" placeholder="0.6" />
            </div>
          </div>
          <div style="margin-top: 16px;">
            <label for="aiSystemPrompt">System Prompt</label>
            <textarea id="aiSystemPrompt" placeholder="AI 기본 지침을 입력하세요."></textarea>
          </div>

          <div class="grid grid-2" style="margin-top: 20px;">
            <div>
              <h3>OpenAI</h3>
              <label for="openaiModel">모델 이름</label>
              <input id="openaiModel" type="text" placeholder="예: gpt-4o-mini" />
              <label for="openaiBaseUrl" style="margin-top: 12px;">Base URL</label>
              <input id="openaiBaseUrl" type="text" placeholder="https://api.openai.com/v1" />
              <label for="openaiOrg" style="margin-top: 12px;">조직 ID</label>
              <input id="openaiOrg" type="text" placeholder="Optional" />
              <label for="openaiApiKey" style="margin-top: 12px;">새 API 키</label>
              <input id="openaiApiKey" type="password" placeholder="새 키 입력 (비워두면 유지)" />
              <button id="btnClearOpenAiKey" class="secondary" type="button" style="margin-top: 10px;">저장된 OpenAI 키 제거</button>
            </div>
            <div>
              <h3>Vertex AI</h3>
              <label for="vertexModel">모델 이름</label>
              <input id="vertexModel" type="text" placeholder="예: gemini-1.5-flash" />
              <label for="vertexLocation" style="margin-top: 12px;">리전</label>
              <input id="vertexLocation" type="text" placeholder="예: us-central1" />
              <div class="muted" style="margin-top: 16px;">Vertex AI를 사용하려면 Cloud Run 환경 변수에 서비스 계정 권한이 필요합니다.</div>
            </div>
          </div>

          <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button id="btnSaveConfig" class="primary" type="button">설정 저장</button>
          </div>
        </section>

        <section class="card hidden" id="partnerSection">
          <h2>동료 매칭</h2>
          <p class="muted" style="margin-bottom: 12px;">세션을 선택한 후 동료의 세션 키를 지정하거나 이름/식별 번호를 직접 입력해 매칭하세요.</p>
          <textarea id="partnerBulkInput" placeholder="세션키, 이름, 식별번호 순으로 한 줄에 입력하세요.
예) SessionA, 홍길동, A10100"></textarea>
          <div class="match-actions" style="margin-top: 16px;">
            <button id="btnParseBulk" class="secondary" type="button">붙여넣기 분석</button>
            <button id="btnAssignPartner" class="primary" type="button" disabled>동료 저장</button>
            <button id="btnClearPartner" class="secondary" type="button" disabled>동료 연결 해제</button>
            <button id="btnJumpPartner" class="link-button" type="button" disabled>동료 세션 열기</button>
          </div>
        </section>

        <section class="card" id="rosterSection">
          <h2>학생 명단</h2>
          <p class="muted" style="margin-bottom: 12px;">식별번호와 이름을 한 줄씩 입력하거나 붙여넣으세요. 중복은 자동으로 정리됩니다.</p>
          <textarea id="rosterTextarea" placeholder="식별번호, 이름"></textarea>
          <div class="match-actions" style="margin-top: 16px; align-items: center;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button id="btnRosterSave" class="primary" type="button">명단 저장</button>
              <button id="btnRosterReload" class="secondary" type="button">명단 새로고침</button>
            </div>
            <span class="muted" id="rosterCountLabel" style="margin-left: auto;">등록된 학생 0명</span>
          </div>
        </section>

        <section class="card" id="sessionListSection">
          <h2>세션 목록</h2>
          <div class="muted" style="margin-bottom: 12px;">목록에서 세션을 선택하면 상세 정보와 대화 로그를 확인하고 동료를 매칭할 수 있습니다.</div>
          <div style="overflow-x: auto;">
            <table id="sessionTable">
              <thead>
                <tr>
                  <th>세션</th>
                  <th>집단</th>
                  <th>학생</th>
                  <th>단계</th>
                  <th>동료</th>
                  <th>업데이트</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <section class="card hidden" id="sessionDetailSection">
          <h2>세션 상세</h2>
          <div id="sessionDetail" class="muted">세션을 선택하면 내용이 표시됩니다.</div>
        </section>

        <section class="card hidden" id="chatSection">
          <h2>대화 로그</h2>
          <div class="grid grid-2" style="margin-top: 16px;">
            <div>
              <h3>AI 피드백</h3>
              <pre id="aiChatLog">세션을 선택하세요.</pre>
            </div>
            <div>
              <h3>동료 피드백</h3>
              <pre id="peerChatLog">세션을 선택하세요.</pre>
            </div>
          </div>
        </section>
      </div>
    </div>

    <script>
      (function(){
        'use strict';

        const APP = window.APP_CONFIG || { apiBaseUrl: '/api', apiKey: '' };
        let authToken = window.localStorage.getItem('writingresearch_admin_token') || '';
        let selectedSessionKey = '';
        let clearOpenAiKey = false;
        let currentSessionDetail = null;
        let rosterStudents = [];

        const sessionCache = new Map();
        const $ = (id) => document.getElementById(id);

        function normalizeBaseUrl(url){
          if (!url) return `${window.location.origin}/api/`;
          const trimmed = String(url).trim();
          if (/^https?:\/\//i.test(trimmed)) {
            return trimmed.endsWith('/') ? trimmed : `${trimmed}/`;
          }
          const prefixed = trimmed.startsWith('/') ? trimmed : `/${trimmed}`;
          const combined = `${window.location.origin}${prefixed}`;
          return combined.endsWith('/') ? combined : `${combined}/`;
        }

        const API_BASE = new URL('admin/', normalizeBaseUrl(APP.apiBaseUrl || '/api')).toString();

        function setStatus(message, type){
          const bar = $('statusBar');
          bar.textContent = message;
          bar.className = `status-bar${type ? ' ' + type : ''}`;
        }

        async function apiRequest(path, { method = 'GET', body, requireAuth = true } = {}) {
          const url = new URL(path, API_BASE).toString();
          const headers = { 'Content-Type': 'application/json' };
          if (requireAuth && authToken) headers['Authorization'] = `Bearer ${authToken}`;
          const response = await fetch(url, {
            method,
            headers,
            body: body ? JSON.stringify(body) : undefined
          });
          if (response.status === 204) return null;
          const text = await response.text();
          let payload = null;
          if (text) {
            try { payload = JSON.parse(text); } catch (err) { throw new Error('서버 응답을 해석하지 못했습니다.'); }
          }
          if (!response.ok) {
            const error = new Error(payload?.error || payload?.message || response.statusText || '요청 실패');
            error.status = response.status;
            throw error;
          }
          return payload;
        }

        function showLogin(){
          $('loginView').classList.remove('hidden');
          $('adminView').classList.add('hidden');
          setStatus('관리자 비밀번호를 입력하세요.', '');
        }

        function showAdmin(){
          $('loginView').classList.add('hidden');
          $('adminView').classList.remove('hidden');
          setStatus('관리자 모드에 접속했습니다.', 'success');
        }

        async function attemptAutoLogin(){
          if (!authToken) return false;
          try {
            await loadConfig();
            await loadSessions();
            showAdmin();
            return true;
          } catch (error) {
            authToken = '';
            window.localStorage.removeItem('writingresearch_admin_token');
            showLogin();
            return false;
          }
        }

        async function login(){
          const password = $('adminPassword').value.trim();
          if (!password) {
            setStatus('비밀번호를 입력하세요.', 'error');
            return;
          }
          $('btnLogin').disabled = true;
          try {
            const payload = await apiRequest('login', { method: 'POST', body: { password }, requireAuth: false });
            authToken = payload?.token || '';
            if (!authToken) throw new Error('토큰을 수신하지 못했습니다.');
            window.localStorage.setItem('writingresearch_admin_token', authToken);
            $('adminPassword').value = '';
            await loadConfig();
            await loadSessions();
            showAdmin();
          } catch (error) {
            setStatus(error.message || '로그인에 실패했습니다.', 'error');
          } finally {
            $('btnLogin').disabled = false;
          }
        }

        async function logout(){
          try {
            await apiRequest('logout', { method: 'POST' });
          } catch (error) {
            console.warn(error);
          }
          authToken = '';
          window.localStorage.removeItem('writingresearch_admin_token');
          $('adminPassword').value = '';
          sessionCache.clear();
          currentSessionDetail = null;
          $('sessionTable').querySelector('tbody').innerHTML = '';
          resetDetailPanels();
          clearOpenAiKey = false;
          showLogin();
        }

        async function loadConfig(){
          const data = await apiRequest('config');
          const ai = data?.ai || {};
          const overrides = data?.overrides || {};
          $('aiProvider').value = overrides.provider || 'auto';
          $('aiTemperature').value = overrides.temperature ?? '';
          $('aiSystemPrompt').value = overrides.systemPrompt || '';
          $('openaiModel').value = overrides.openai?.model || ai.openai?.model || '';
          $('openaiBaseUrl').value = overrides.openai?.baseUrl || ai.openai?.baseUrl || '';
          $('openaiOrg').value = overrides.openai?.organization || ai.openai?.organization || '';
          $('vertexModel').value = overrides.vertex?.model || ai.vertex?.model || '';
          $('vertexLocation').value = overrides.vertex?.location || ai.vertex?.location || '';
          $('openaiApiKey').value = '';
          clearOpenAiKey = false;

          const badge = document.createElement('span');
          badge.className = `badge ${ai.provider === 'openai' ? 'openai' : ai.provider === 'vertex' ? 'vertex' : 'disabled'}`;
          badge.textContent = ai.provider === 'openai' ? 'OpenAI 사용 중' : ai.provider === 'vertex' ? 'Vertex AI 사용 중' : 'AI 비활성화';
          const statusContainer = document.createElement('div');
          statusContainer.className = 'ai-status';
          statusContainer.appendChild(badge);
          const configSection = $('adminView').querySelector('section.card');
          const previousStatus = configSection.querySelector('.ai-status');
          if (previousStatus) previousStatus.remove();
          configSection.insertBefore(statusContainer, configSection.children[1]);
        }

        async function saveConfig(){
          const provider = $('aiProvider').value;
          const temperatureValue = $('aiTemperature').value;
          const systemPrompt = $('aiSystemPrompt').value;
          const payload = {
            provider,
            temperature: temperatureValue === '' ? null : Number(temperatureValue),
            systemPrompt,
            openai: {
              model: $('openaiModel').value,
              baseUrl: $('openaiBaseUrl').value,
              organization: $('openaiOrg').value
            },
            vertex: {
              model: $('vertexModel').value,
              location: $('vertexLocation').value
            }
          };

          const apiKeyInput = $('openaiApiKey').value;
          if (clearOpenAiKey) {
            payload.openai.apiKey = null;
          } else if (apiKeyInput && apiKeyInput.trim()) {
            payload.openai.apiKey = apiKeyInput.trim();
          }

          $('btnSaveConfig').disabled = true;
          try {
            await apiRequest('config', { method: 'POST', body: payload });
            $('openaiApiKey').value = '';
            clearOpenAiKey = false;
            setStatus('AI 설정이 저장되었습니다.', 'success');
            await loadConfig();
          } catch (error) {
            setStatus(error.message || '설정 저장에 실패했습니다.', 'error');
          } finally {
            $('btnSaveConfig').disabled = false;
          }
        }

        async function loadSessions(){
          const data = await apiRequest('sessions');
          const list = data?.sessions || [];
          const tbody = $('sessionTable').querySelector('tbody');
          const optionList = $('sessionOptions');
          tbody.innerHTML = '';
          optionList.innerHTML = '';
          sessionCache.clear();

          if (!list.length) {
            resetDetailPanels();
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 6;
            cell.className = 'muted';
            cell.textContent = '등록된 세션이 없습니다.';
            row.appendChild(cell);
            tbody.appendChild(row);
            return;
          }

          list.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
          list.forEach((item) => {
            sessionCache.set(item.sessionKey, item);
            const option = document.createElement('option');
            option.value = item.sessionKey;
            const studentLabel = `${item.user?.name || ''} ${item.user?.id ? `(${item.user.id})` : ''}`.trim();
            option.label = `${item.sessionKey} · ${studentLabel || '학생 정보 없음'}`;
            optionList.appendChild(option);

            const row = document.createElement('tr');
            row.dataset.sessionKey = item.sessionKey;
            if (item.sessionKey === selectedSessionKey) row.classList.add('active');
            const stageLabel = `단계 ${item.stage || 1}`;
            const updated = item.updatedAt ? formatDateTime(item.updatedAt) : '-';
            const partnerLabel = formatPartnerCell(item.partner);
            row.innerHTML = `
              <td>${item.sessionKey}</td>
              <td>${item.group || '-'}</td>
              <td>${escapeHtml(item.user?.name || '')} ${item.user?.id ? `(${escapeHtml(item.user.id)})` : ''}</td>
              <td>${stageLabel}</td>
              <td>${partnerLabel}</td>
              <td>${updated}</td>
            `;
            row.addEventListener('click', () => selectSession(item.sessionKey));
            tbody.appendChild(row);
          });
        }

        async function selectSession(sessionKey){
          selectedSessionKey = sessionKey;
          const rows = $('sessionTable').querySelectorAll('tbody tr');
          rows.forEach((row) => {
            row.classList.toggle('active', row.dataset.sessionKey === sessionKey);
          });
          setStatus(`세션 ${sessionKey} 상세 정보를 불러오는 중입니다.`, '');
          try {
            const [{ session }, aiChats, peerChats] = await Promise.all([
              apiRequest(`sessions/${sessionKey}`),
              apiRequest(`sessions/${sessionKey}/chats/ai`),
              apiRequest(`sessions/${sessionKey}/chats/peer`)
            ]);
            currentSessionDetail = session;
            sessionCache.set(session.sessionKey, {
              ...(sessionCache.get(session.sessionKey) || {}),
              partner: session.partner,
              user: session.you,
              group: session.mode,
              stage: session.stage,
              updatedAt: session.updatedAt
            });
            showDetailPanels();
            renderSessionDetail(session);
            populatePartnerForm(session);
            renderChatLogs(aiChats?.messages || [], peerChats?.messages || []);
            setStatus(`세션 ${sessionKey} 상세 정보를 불러왔습니다.`, 'success');
          } catch (error) {
            setStatus(error.message || '세션 정보를 불러오지 못했습니다.', 'error');
          }
        }

        function renderSessionDetail(session){
          const container = $('sessionDetail');
          if (!session) {
            container.textContent = '세션 데이터를 찾을 수 없습니다.';
            return;
          }
          const updatedAt = session.updatedAt ? formatDateTime(session.updatedAt) : '정보 없음';
          const createdAt = session.createdAt ? formatDateTime(session.createdAt) : '정보 없음';
          const studentName = escapeHtml(session.you?.name || '이름 없음');
          const studentId = escapeHtml(session.you?.id || '-');
          const partnerInfo = session.partner ? formatPartnerDetail(session.partner) : '';

          const stageBlocks = buildStageBlocks(session).join('');

          container.innerHTML = `
            <div class="detail-heading">
              <div class="detail-id">
                <strong>${studentName}</strong>
                <span class="badge group">${escapeHtml(session.mode || '-')} 집단</span>
                <span class="badge stage">단계 ${session.stage || 1}</span>
              </div>
              <div class="muted">최근 업데이트 · ${updatedAt}</div>
            </div>
            <div class="detail-info-grid">
              <div><span class="detail-label">세션 키</span><p>${escapeHtml(session.sessionKey)}</p></div>
              <div><span class="detail-label">식별 번호</span><p>${studentId}</p></div>
              <div><span class="detail-label">생성 시간</span><p>${createdAt}</p></div>
              <div><span class="detail-label">AI 세션</span><p>${escapeHtml(session.aiSessionId || '-')}</p></div>
            </div>
            ${partnerInfo}
            <div class="stage-list">
              ${stageBlocks}
            </div>
          `;
        }

        function renderChatLogs(aiMessages, peerMessages){
          const format = (list) => {
            if (!list.length) return '대화 기록이 없습니다.';
            return list
              .map((msg) => {
                const time = msg.ts ? formatDateTime(msg.ts) : '';
                const name = msg.senderName || msg.role || '사용자';
                return `[${time}] ${name}:\n${msg.text || ''}`;
              })
              .join('\n\n');
          };
          $('aiChatLog').textContent = format(aiMessages);
          $('peerChatLog').textContent = format(peerMessages);
        }

        $('btnLogin').addEventListener('click', login);
        $('btnClearStored').addEventListener('click', () => {
          window.localStorage.removeItem('writingresearch_admin_token');
          authToken = '';
          setStatus('저장된 토큰을 삭제했습니다.', 'success');
        });
        $('btnLogout').addEventListener('click', logout);
        $('btnReloadSessions').addEventListener('click', async () => {
          try {
            await loadSessions();
            setStatus('세션 목록을 새로고침했습니다.', 'success');
          } catch (error) {
            setStatus(error.message || '세션 목록을 불러오지 못했습니다.', 'error');
          }
        });
        $('btnReloadConfig').addEventListener('click', async () => {
          try {
            await loadConfig();
            setStatus('AI 설정을 새로고침했습니다.', 'success');
          } catch (error) {
            setStatus(error.message || 'AI 설정을 불러오지 못했습니다.', 'error');
          }
        });
        $('btnDownloadExport').addEventListener('click', downloadExport);
        $('btnSaveConfig').addEventListener('click', saveConfig);
        $('btnClearOpenAiKey').addEventListener('click', () => {
          clearOpenAiKey = true;
          $('openaiApiKey').value = '';
          setStatus('OpenAI 키를 삭제하도록 설정했습니다. 저장을 눌러 반영하세요.', '');
        });

        $('btnParseBulk').addEventListener('click', () => parseBulkPartnerInput(false));
        $('partnerBulkInput').addEventListener('input', () => parseBulkPartnerInput(true));
        $('btnAssignPartner').addEventListener('click', assignPartner);
        $('btnClearPartner').addEventListener('click', clearPartner);
        $('btnJumpPartner').addEventListener('click', jumpToPartner);
        $('btnRosterSave').addEventListener('click', saveRoster);
        $('btnRosterReload').addEventListener('click', loadRoster);
        $('rosterTextarea').addEventListener('input', handleRosterInput);

        attemptAutoLogin();
        function resetDetailPanels(){
          $('sessionDetailSection').classList.add('hidden');
          $('chatSection').classList.add('hidden');
          $('partnerSection').classList.add('hidden');
          $('sessionDetail').textContent = '세션을 선택하면 내용이 표시됩니다.';
          $('aiChatLog').textContent = '세션을 선택하세요.';
          $('peerChatLog').textContent = '세션을 선택하세요.';
          setParsedPartnerValues('', '', '');
          $('btnClearPartner').disabled = true;
        }

        function showDetailPanels(){
          $('sessionDetailSection').classList.remove('hidden');
          $('chatSection').classList.remove('hidden');
          $('partnerSection').classList.remove('hidden');
        }

        function formatPartnerCell(partner){
          if (!partner) return '<span class="muted">-</span>';
          const name = escapeHtml(partner.name || '이름 없음');
          const id = escapeHtml(partner.id || '');
          const sessionKey = escapeHtml(partner.sessionKey || '');
          const parts = [name];
          if (id) parts.push(`(${id})`);
          if (sessionKey) parts.push(`<br/><span class="muted">${sessionKey}</span>`);
          return parts.join(' ');
        }

        function formatPartnerDetail(partner){
          const name = escapeHtml(partner.name || '미지정');
          const id = escapeHtml(partner.id || '-');
          const sessionKey = escapeHtml(partner.sessionKey || '-');
          return `
            <div class="detail-partner-block">
              <div class="detail-partner-header">
                <div>
                  <span class="detail-label">동료 매칭</span>
                  <p style="margin: 4px 0 0; font-weight: 600;">${name}</p>
                </div>
                <span class="muted">세션 키 · ${sessionKey}</span>
              </div>
              <div class="muted">식별 번호 · ${id}</div>
            </div>
          `;
        }

        function buildStageBlocks(session){
          const list = [];
          const stages = [
            {
              title: '1단계 · 사전 글쓰기',
              meta: session.writing?.prewriting?.submittedAt ? `제출 시간 · ${formatDateTime(session.writing.prewriting.submittedAt)}` : '제출되지 않았습니다.',
              text: session.writing?.prewriting?.text,
              empty: '사전 글쓰기가 작성되지 않았습니다.'
            },
            {
              title: '2단계 · 수정 아이디어 메모',
              meta: session.writing?.draft?.savedAt ? `저장 시간 · ${formatDateTime(session.writing.draft.savedAt)}` : '저장된 메모가 없습니다.',
              text: session.writing?.draft?.text,
              empty: '2단계 메모가 작성되지 않았습니다.'
            },
            {
              title: '3단계 · 동료 피드백 메모',
              meta: session.writing?.notes?.updatedAt ? `저장 시간 · ${formatDateTime(session.writing.notes.updatedAt)}` : '작성된 동료 피드백 메모가 없습니다.',
              text: session.writing?.notes?.text,
              empty: '3단계 메모가 작성되지 않았습니다.'
            },
            {
              title: '4단계 · 최종 글',
              meta: session.writing?.final?.submittedAt ? `제출 시간 · ${formatDateTime(session.writing.final.submittedAt)}` : '최종 글이 아직 제출되지 않았습니다.',
              text: session.writing?.final?.text,
              empty: '최종 글이 아직 작성되지 않았습니다.'
            }
          ];

          stages.forEach((stage) => {
            const content = stage.text ? escapeHtml(stage.text) : `<span class="muted">${stage.empty}</span>`;
            list.push(`
              <div class="stage-block">
                <div class="stage-title">${stage.title}</div>
                <div class="stage-meta">${stage.meta}</div>
                <pre>${content}</pre>
              </div>
            `);
          });
          return list;
        }

        function populatePartnerForm(session){
          const assignBtn = $('btnAssignPartner');
          const clearBtn = $('btnClearPartner');
          const jumpBtn = $('btnJumpPartner');
          const bulkInput = $('partnerBulkInput');

          if (!session) {
            assignBtn.disabled = true;
            clearBtn.disabled = true;
            jumpBtn.disabled = true;
            jumpBtn.dataset.sessionKey = '';
            bulkInput.value = '';
            bulkInput.dataset.sessionKey = '';
            bulkInput.dataset.name = '';
            bulkInput.dataset.id = '';
            return;
          }

          const partner = session.partner || null;
          if (partner) {
            const suggestion = [partner.sessionKey || '', partner.name || '', partner.id || '']
              .filter(Boolean)
              .join(', ');
            bulkInput.value = suggestion;
            setParsedPartnerValues(partner.sessionKey || '', partner.name || '', partner.id || '');
          } else {
            bulkInput.value = '';
            setParsedPartnerValues('', '', '');
          }
          clearBtn.disabled = !partner;
          jumpBtn.disabled = !partner?.sessionKey;
          jumpBtn.dataset.sessionKey = partner?.sessionKey || '';
        }

        async function assignPartner(){
          if (!selectedSessionKey) return;
          parseBulkPartnerInput(true);
          const payload = {};
          const sessionValue = $('partnerBulkInput').dataset.sessionKey?.trim() || '';
          const nameValue = $('partnerBulkInput').dataset.name?.trim() || '';
          const idValue = $('partnerBulkInput').dataset.id?.trim() || '';
          if (!sessionValue && !idValue) {
            setStatus('동료 식별번호 또는 세션 키를 입력하세요.', 'error');
            return;
          }
          if (sessionValue) payload.partnerSessionKey = sessionValue;
          if (nameValue) payload.partnerName = nameValue;
          if (idValue) payload.partnerId = idValue;

          $('btnAssignPartner').disabled = true;
          try {
            const response = await apiRequest(`sessions/${selectedSessionKey}/partner`, { method: 'POST', body: payload });
            currentSessionDetail = response.session;
            setStatus('동료 정보를 저장했습니다.', 'success');
            populatePartnerForm(currentSessionDetail);
            renderSessionDetail(currentSessionDetail);
            setParsedPartnerValues(sessionValue, nameValue, idValue);
            await loadSessions();
          } catch (error) {
            setStatus(error.message || '동료 정보를 저장하지 못했습니다.', 'error');
          }
        }

        async function clearPartner(){
          if (!selectedSessionKey) return;
          $('btnClearPartner').disabled = true;
          try {
            const response = await apiRequest(`sessions/${selectedSessionKey}/partner`, { method: 'DELETE' });
            currentSessionDetail = response.session;
            setStatus('동료 연결을 해제했습니다.', 'success');
            populatePartnerForm(currentSessionDetail);
            renderSessionDetail(currentSessionDetail);
            setParsedPartnerValues('', '', '');
            await loadSessions();
          } catch (error) {
            setStatus(error.message || '동료 연결을 해제하지 못했습니다.', 'error');
          }
        }

        function jumpToPartner(){
          const key = $('btnJumpPartner').dataset.sessionKey;
          if (!key) return;
          selectSession(key);
        }

        function parseBulkPartnerInput(silent = false){
          const textarea = $('partnerBulkInput');
          const raw = textarea.value.trim();
          if (!raw) {
            setParsedPartnerValues('', '', '');
            return;
          }
          const firstLine = raw.split(/\r?\n/)[0];
          const normalized = firstLine.replace(/\t/g, ',');
          const pieces = normalized.split(',').map((part) => part.trim());
          const sessionKey = pieces[0] || '';
          const candidate = sessionCache.get(sessionKey);
          const nameValue = pieces[1] || candidate?.user?.name || '';
          let idValue = pieces[2] || candidate?.user?.id || '';
          if (!sessionKey && !idValue) {
            const rosterMatch = findRosterByName(nameValue);
            if (rosterMatch) {
              idValue = rosterMatch.id;
            }
          }
          const rebuilt = [sessionKey, nameValue, idValue].filter(Boolean).join(', ');
          textarea.value = rebuilt;
          setParsedPartnerValues(sessionKey, nameValue, idValue);
          if (!silent) {
            setStatus('입력한 동료 정보를 불러왔습니다.', 'success');
          }
        }

        function formatDateTime(ms){
          if (!ms) return '정보 없음';
          return new Date(ms).toLocaleString('ko-KR');
        }

        function escapeHtml(str){
          return String(str || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }

        function setParsedPartnerValues(sessionKey, name, id){
          const textarea = $('partnerBulkInput');
          textarea.dataset.sessionKey = sessionKey || '';
          textarea.dataset.name = name || '';
          textarea.dataset.id = id || '';
          const existing = currentSessionDetail?.partner || {};
          const changed =
            (sessionKey || '') !== (existing.sessionKey || '') ||
            (name || '') !== (existing.name || '') ||
            (id || '') !== (existing.id || '');
          const hasValue = Boolean(sessionKey || name || id);
          $('btnAssignPartner').disabled = !(changed && hasValue);
          $('btnJumpPartner').disabled = !sessionKey;
          $('btnJumpPartner').dataset.sessionKey = sessionKey || '';
        }

        async function downloadExport(){
          if (!authToken) {
            setStatus('로그인 후 이용하세요.', 'error');
            return;
          }
          const button = $('btnDownloadExport');
          button.disabled = true;
          try {
            setStatus('전체 데이터를 준비 중입니다...', '');
            const url = new URL('sessions/export/json', API_BASE).toString();
            const headers = { Accept: 'application/json' };
            if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
            const response = await fetch(url, { headers });
            if (!response.ok) {
              const text = await response.text();
              throw new Error(text || '데이터를 내보내지 못했습니다.');
            }
            const blob = await response.blob();
            const stamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `writingresearch-export-${stamp}.json`;
            const blobUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(blobUrl);
            setStatus('데이터 내보내기가 완료되었습니다.', 'success');
          } catch (error) {
            setStatus(error.message || '데이터 내보내기에 실패했습니다.', 'error');
          } finally {
            button.disabled = false;
          }
        }
        async function loadRoster(){
          try {
            const data = await apiRequest('roster');
            rosterStudents = Array.isArray(data?.students) ? data.students : [];
            renderRoster();
            setStatus('학생 명단을 불러왔습니다.', 'success');
          } catch (error) {
            setStatus(error.message || '학생 명단을 불러오지 못했습니다.', 'error');
          }
        }

        async function saveRoster(){
          const textarea = $('rosterTextarea');
          const students = parseRosterTextarea(textarea.value);
          if (!students.length) {
            setStatus('저장할 학생 정보가 없습니다.', 'error');
            return;
          }
          $('btnRosterSave').disabled = true;
          try {
            const result = await apiRequest('roster', { method: 'POST', body: { students } });
            rosterStudents = Array.isArray(result?.students) ? result.students : [];
            renderRoster();
            setStatus('학생 명단을 저장했습니다.', 'success');
            await loadSessions();
          } catch (error) {
            setStatus(error.message || '학생 명단을 저장하지 못했습니다.', 'error');
          } finally {
            $('btnRosterSave').disabled = false;
          }
        }

        function handleRosterInput(){
          const textarea = $('rosterTextarea');
          const students = parseRosterTextarea(textarea.value);
          updateRosterCount(students.length);
        }

        function parseRosterTextarea(text){
          return String(text || '')
            .split(/\r?\n/)
            .map((line) => line.replace(/\t/g, ',').trim())
            .filter(Boolean)
            .map((line) => line.split(',').map((part) => part.trim()))
            .map(([id, name]) => ({ id, name }))
            .filter((item) => item.id || item.name);
        }

        function renderRoster(){
          const textarea = $('rosterTextarea');
          const sorted = [...rosterStudents].sort((a, b) => a.id.localeCompare(b.id));
          textarea.value = sorted.map((item) => [item.id, item.name].filter(Boolean).join(', ')).join('\n');
          updateRosterCount(sorted.length);
        }

        function updateRosterCount(count){
          $('rosterCountLabel').textContent = `등록된 학생 ${count}명`;
        }

        function findRosterByName(name){
          const trimmed = (name || '').trim();
          if (!trimmed) return null;
          return rosterStudents.find((student) => (student.name || '').trim() === trimmed) || null;
        }

        async function attemptAutoLogin(){
          if (!authToken) {
            showLogin();
            return;
          }
          try {
            await loadConfig();
            await Promise.all([loadSessions(), loadRoster()]);
            showAdmin();
          } catch (error) {
            authToken = '';
            window.localStorage.removeItem('writingresearch_admin_token');
            showLogin();
          }
        }
        attemptAutoLogin();
      })();
    </script>
  </body>
</html>
